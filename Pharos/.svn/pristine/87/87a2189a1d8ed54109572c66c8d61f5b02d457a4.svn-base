using Pharos.POS.Retailing.ObjectModels;
using Pharos.Wpf.ViewModelHelpers;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Pharos.POS.Retailing.ViewModels
{
    /// <summary>
    /// 查询历史订单
    /// </summary>
    public class FindBills : BaseViewModel
    {
        private DateTime searchTime = DateTime.Now;

        public DateTime SearchTime
        {
            get { return searchTime; }
            set { searchTime = value; }
        }
        private IEnumerable<OrderInfoModel> orderItems;

        public IEnumerable<OrderInfoModel> OrderItems
        {
            get { return orderItems; }
            set { orderItems = value; this.OnPropertyChanged(o => o.OrderItems); }
        }

        public GeneralCommand<object> SearchCommand
        {
            get
            {
                return new GeneralCommand<object>((o1, o2) =>
                {
                    Task.Factory.StartNew(() =>
                    {
                        var _machinesInfo = Global.MachineSettings.MachineInformations;
                        FindBillsParams _params = new FindBillsParams() { Date = SearchTime, StoreId = _machinesInfo.StoreId, MachineSn = _machinesInfo.MachineSn };
                        var result = ApiManager.Post<FindBillsParams, ApiRetrunResult<IEnumerable<OrderInfoModel>>>(@"api/FindBills", _params);
                        if (result.Code == "200")
                        {
                            CurrentWindow.Dispatcher.Invoke(new Action(() =>
                            {
                                OrderItems = result.Result;
                            }));
                        }
                        else
                        {
                            Toast.ShowMessage(result.Message, CurrentWindow);
                        }
                    });
                });
            }
        }
    }
}
