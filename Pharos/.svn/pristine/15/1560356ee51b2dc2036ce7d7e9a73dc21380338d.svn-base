using Pharos.Utility.Helpers;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Text;

namespace Pharos.Logic.DAL
{
    /// <summary>
    /// 销售订单 数据访问
    /// </summary>
    internal class SaleOrderDAL : BaseDAL
    {
        public DataTable QuerySaleOrdersPageList(System.Collections.Specialized.NameValueCollection nvl, out int recordCount)
        {
            var startDate = nvl["date"];
            var endDate = nvl["date2"];
            var cashier = nvl["cashier"];
            var saler = nvl["saler"];
            var store = nvl["store"];

            string sql = @"SELECT Id,CreateDT,Cashier,Saler,Store,PaySN,TotalAmount,PreferentialPrice,ApiTitle,Title,PurchaseNumber,SysPrice,ActualPrice,Barcode,SalesClassify FROM(	
		                SELECT a.*,dbo.F_UserNameById(CreateUID) Cashier,dbo.F_UserNameById(Salesman) Saler, dbo.F_StoreNameById(StoreId) Store,
        				c.Title, b.PurchaseNumber, b.SysPrice, b.ActualPrice, b.Barcode, dbo.F_DicNameForSN(b.SalesClassifyId) SalesClassify,
                        STUFF((SELECT ','+Title FROM ConsumptionPayment,ApiLibrary WHERE ApiLibrary.ApiCode=dbo.ConsumptionPayment.ApiCode AND PaySN=a.PaySN FOR XML PATH('')),1,1,'') ApiTitle
                        FROM dbo.SaleOrders a
				        INNER JOIN dbo.SaleDetail b ON a.PaySN = b.PaySN
				        LEFT JOIN dbo.ProductRecord c ON b.Barcode = c.Barcode
		                WHERE 1 = 1 ";
            if (!startDate.IsNullOrEmpty())
                sql += " AND CreateDT >= '" + startDate + "'";
            if (!endDate.IsNullOrEmpty())
                sql += " AND CreateDT < '" + endDate + "'";
            if (!store.IsNullOrEmpty())
                sql += " AND StoreId = '" + store + "'";
            if (!cashier.IsNullOrEmpty())
                sql += " AND CreateUID = '" + cashier + "'";
            if (!saler.IsNullOrEmpty())
                sql += " AND Salesman = '" + saler + "'";
            sql += ") tb ";
            return base.ExceuteSqlForPage(sql, out recordCount);
        }
    }
}
