using Pharos.SocketService.Retailing.Protocol.AppSessions;
using Pharos.SocketService.Retailing.Protocol.CommandProviders;
using Pharos.SocketService.Retailing.Protocol.ReceiveFilters;
using Pharos.SocketService.Retailing.Protocol.RequestInfos;
using Pharos.SocketService.Retailing.Services;
using SuperSocket.SocketBase;
using Pharos.Infrastructure.Data.Redis;
using Newtonsoft.Json;
using Pharos.Infrastructure.Data.Normalize;
using Pharos.ObjectModels.DTOs;
using Pharos.Logic.ApiData.Pos;
using Pharos.Logic.ApiData.Pos.Sale.Suspend;
using Pharos.Logic.ApiData.Pos.Sale;

namespace Pharos.SocketService.Retailing.Protocol.AppServers
{
    public class PosStoreServer : AppServer<PosStoreSession, PosStoreRequestInfo>
    {
        public PosStoreServer()
            : base(new IReceiveFilterFactory())
        {
            _cmdNameProvider = new PosStoreCommandNameProvider();
            _sessionManager = new SessionManager(this);
            SubscribeStoreMesssage();
        }

        private ICommandNameProvider _cmdNameProvider = null;

        public ICommandNameProvider CommandNameProvider
        {
            get { return _cmdNameProvider; }
        }
        private ISessionManager _sessionManager = null;

        internal ISessionManager SessionManager
        {
            get { return _sessionManager; }
        }

        private void SubscribeStoreMesssage()
        {
            RedisManager.Subscribe("SyncDatabase", (channel, info) =>
            {
                var databaseChanged = JsonConvert.DeserializeObject<DatabaseChanged>(info);
                var session = SessionManager.GetRegistered(new Models.Pos.PosStoreSessionInfo() { CompanyId = databaseChanged.CompanyId, StoreId = databaseChanged.StoreId });
                if (session != null && session.Status == SessionStatus.Started)
                {
                    session.SendObject(new byte[4] { 0x00, 0x00, 0x00, 0x05 }, databaseChanged);
                }
            });
            RedisManager.Subscribe("SyncSerialNumber", (channel, info) =>
            {
                var paysn = JsonConvert.DeserializeObject<PaySn>(info);
                var session = SessionManager.GetRegistered(new Models.Pos.PosStoreSessionInfo() { CompanyId = paysn.CompanyToken, StoreId = paysn.StoreId });
                if (session != null && session.Status == SessionStatus.Started)
                {
                    session.SendObject(new byte[4] { 0x00, 0x00, 0x00, 0x02 }, paysn);
                }
            });
            RedisManager.Subscribe("SyncOnlineCache", (channel, info) =>
            {
                var machineInformation = JsonConvert.DeserializeObject<MachineInformation>(info);
                var session = SessionManager.GetRegistered(new Models.Pos.PosStoreSessionInfo() { CompanyId = machineInformation.CompanyToken, StoreId = machineInformation.StoreId });
                if (session != null && session.Status == SessionStatus.Started)
                {
                    session.SendObject(new byte[4] { 0x00, 0x00, 0x00, 0x04 }, machineInformation);
                }

            });
            RedisManager.Subscribe("SyncShoppingCartCache", (channel, info) =>
            {
                var jsonSerializerSettings = new Newtonsoft.Json.JsonSerializerSettings();
                jsonSerializerSettings.Converters.Add(new BarcodeConverter());
                var shoppingCart = JsonConvert.DeserializeObject<ShoppingCart>(info, jsonSerializerSettings);
                var session = SessionManager.GetRegistered(new Models.Pos.PosStoreSessionInfo() { CompanyId = shoppingCart.MachineInformation.CompanyToken, StoreId = shoppingCart.MachineInformation.StoreId });
                if (session != null && session.Status == SessionStatus.Started)
                {
                    session.SendObject(new byte[4] { 0x00, 0x00, 0x00, 0x03 }, shoppingCart);
                }
            });
        }
    }
}
