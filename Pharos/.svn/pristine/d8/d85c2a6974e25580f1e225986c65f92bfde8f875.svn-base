@{
    ViewBag.Title = Pharos.Sys.SysConstPool.Page_Title;
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";
    ViewData.OpBtnInfo(new OpBtnInfo(hideAdd: true, hideEdit: false, hideDel: true, searchHeight: 80));
}

@section search{
    <table class="table-toolbar">
        <tr>
            <td class="label-toolbar">
                <label>日 期：</label>
            </td>
            <td class="input-toolbar">
                <input name="date" id="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" style="width:100px" class="datacontrol Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd', maxDate: '#F{$dp.$D(\'date2\')}' })" />-
            </td>
            <td class="input-toolbar">
                <input name="date2" id="date2" value="@DateTime.Now.ToString("yyyy-MM-dd")" style="width:100px" class="datacontrol Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd', minDate: '#F{$dp.$D(\'date\')}' })" />
            </td>
            <td class="label-toolbar">
                <label>门 店：</label>
            </td>
            <td class="input-toolbar">
                @Form.Combobox("store", ViewBag.stores as List<SelectListItem>, dataOptions: (CurrentUser.IsStore ? "readonly:true," : "") + "editable:false,panelMaxHeight:200")
            </td>
            <td class="label-toolbar">
                <label>品 类：</label>
            </td>
            <td class="input-toolbar">
                @Form.CategoryCombobox("parentType", true)
            </td>
            <td class="label-toolbar">
                <label>品 牌：</label>
            </td>
            <td class="input-toolbar">
                @Form.Combobox("brandsn", ViewBag.brandsns as List<SelectListItem>, dataOptions: "editable:false,panelHeight:'auto',panelMaxHeight:200")
            </td>
        </tr>
        <tr>
            <td class="label-toolbar">
                <label>供应商：</label>
            </td>
            <td class="input-toolbar">
                @Form.SupplierCombobox("supplierId", emptyTitle: "全部", multiple: true, controlWidth: 280,panelWidth:280)
            </td>
            <td class="label-toolbar">
                <label>关键字：</label>
            </td>
            <td class="input-toolbar">
                <select id="searchField" name="searchField" class="easyui-combobox" data-options="editable:false">
                    <option value="barcode">条码</option>
                    <option value="Title">品名</option>
                </select>
                <input type="hidden" name="type" value="2" />
            </td>
            <td class="input-toolbar">
                &nbsp;<select name="searchText" class="easyui-combobox" data-options="prompt:'请输入查询条件...',width:150,mode:'remote',valueField:'value',textField:'text',loader:comboload"></select>
            </td>
            <td class="label-toolbar" id="btns"></td>
        </tr>
    </table>
}
@section toolbar
{
    <a href="#" id="btnExcel" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-export'" onclick="Export()">导出Excel</a>
}
<script type="text/javascript">
    var comboload=function (param, success, error) {
        //获取输入的值
        var q = param.q || "";
        //此处q的length代表输入多少个字符后开始查询
        if (q.length <= 1) return false;
        $.ajax({
            url:"@Url.Action("GetDataForSearch","Report")",
            type:"post",
        data:{
            //传值，还是JSON数据搜索
            searchText: q,
            searchField:$("#searchField").combobox("getValue"),
            product:"1"
        },
        //重要，如果写jsonp会报转换错误，此处不写都可以
        dataType:"json",
        success: function (data) {
            var items = $.map(data, function(item){
                return { value: item.value, text: item.text };
            });
            //执行loader的success方法
            success(items);
        },    //异常处理
        error: function (xml, text, msg) {
            error.apply(this, arguments);
        }
    });
    }
    pharos.manager.geturl = '@Url.Action("ProductOrderDetailPageList")';
    pharos.manager.pagination = true;
    pharos.manager.showFooter = true;
    pharos.manager.pageSize = 50;
    pharos.manager.pageList = [50, 100, 200];
    pharos.manager.columns = [[
        { field: 'ProductCode', title: '商品编码', width: 70 },
        { field: 'Barcode', title: '商品条码', width: 120 },
        { field: 'Title', title: '商品名称', width: 180 },
        { field: 'SubUnit', title: '单位', width: 60 },
        { field: '数量', title: '进货数量', width: 70 },
        { field: '赠品数量', title: '赠品数量', width: 70 },
        { field: '单价', title: '均价', width: 60 },
        { field: '采购金额', title: '采购金额', width: 80 },
        { field: '零售金额', title: '零售金额', width: 80 },
        { field: '未税单价', title: '未税单价', width: 80 },
        { field: '未税金额', title: '未税金额', width: 80 },
        { field: 'StoreTitle', title: '门店', width: 150 }
    ]];
    pharos.manager.frozenColumns = [[
        { field: 'SupplierTitle', title: '主供应商', width: 120 },
        { field: 'InboundGoodsId', title: '单据编号', width: 150 },
        { field: 'OperatDT', title: '操作日期', width: 100 }
    ]]
    pharos.manager.loadSuccess = function () {
        pharos.manager.$dg.datagrid("autoMergeCellsGroupby", { groupby: 'InboundGoodsId', columns: ['SupplierTitle','InboundGoodsId', 'OperatDT'] });
    };
    pharos.manager.editItem = function (id,row) {
        openDialog("采购明细", "@Url.Action("OrderDetail")?barcode=" + row.Barcode + "&store=" + row.StoreId + "&supplierId=" + row.SupplierID +"&"+ $('#frmsearch').serialize(), 1000, 560, true);
    }
    function Export() {
        var date=$("[name='date']").val();
        if (!date) {
            $.messager.alert("提示", "请先选择日期!"); return;
        }
        window.location.href = '@Url.Action("SaleExport")?type=12&' + $('#frmsearch').serialize();
    }
    $(function () {
        $("#btns").append($("#searchBtn")).append($("#btnExcel"));
        $("#toolbar").hide();
    });
</script>