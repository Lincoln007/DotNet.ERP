@{
    ViewBag.Title = "ReturnRulesIndex";
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";
    ViewData.OpBtnInfo(new OpBtnInfo(addText: "新增规则", delText: "移除", hideDel: true, hideSearch: true));
}
@section search{
    <table class="table-toolbar">
        <tr>
            <td class="label-toolbar">
                <label>规则方式：</label>
            </td>
        </tr>
    </table>
}
@section toolbar
{
    <a class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-usable'" onclick="SetReturnRuleState(1)">设为可用</a>
    <a class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-usable'" onclick="SetReturnRuleState(2)">设为过期</a>
    <a class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-usable'" onclick="SetReturnRuleStage()">设置分期</a>
}

<script type="text/javascript">
    pharos.manager.geturl = "@Url.Action("FindReturnRulesList")";
    pharos.manager.editurl = "@Url.Action("CreateReturnRules")";
    pharos.manager.addItem = function () {
        this.Id = "";
        openDialog1000(this.addText, this.editurlNocache(), false);
    }
    pharos.manager.editItem = function (Id, row) {
        this.Id = Id;
        openDialog1000(this.addText, this.editurlNocache(), false);
    }
    pharos.manager.columns = [[
        { field: 'Id', checkbox: true },
        { field: 'Adapters', title: '适配规则', width: 80 },
        {
            field: 'MemberLevelId', title: '对应会员', width: 100, formatter: function (value) {
                if (value == null || value == "") {
                    return "全部";
                } else {
                    return value;
                }
            }
        },
        { field: 'ExpiryStart', title: '有效期', width: 120 },
        { field: 'ExpiryEnd', title: '有效期', width: 120 },
        {
            field: 'State', title: '状态', width: 50, formatter: function (value) {
                switch (value) {
                    case 0:
                        return "未开始";
                    case 1:
                        return "活动中";
                    case 2:
                        return "已过期";
                }
            }
        },
        { field: 'Number1', title: '条件', width: 50, hidden: true },
        {
            field: 'LeftSign', title: '条件1', width: 50, formatter: function (value, row, index) {
                return value + " " + row.Number1;
            }
        },
        { field: 'RightSign', title: '右边', width: 50, hidden: true },
        {
            field: 'Number2', title: '条件2', width: 50, formatter: function (value, row, index) {
                if (value == null || value == "") {
                    return "";
                } else
                    return row.RightSign + " " + value;
            }
        },
        { field: 'Mode', title: '计量', width: 60 },
        { field: 'LimitItems', title: '限定范围', width: 150 },
        {
            field: 'OperationType', title: '操作类型', width: 50
        },
        { field: 'Expression', title: '赠送值', width: 40 },
        { field: 'CreateDT', title: '创建时间', width: 110 },
        { field: 'CreateUID', title: '创建人', width: 40 },
    ]];
    //设置状态
    function SetReturnRuleState(state) {
        var rows = pharos.manager.selectItems();
        if (!rows) return;
        var ids = $.map(rows, function (item) {
            return item.Id;
        }).join();
        $.post("@Url.Action("UpdateReturnRulesState")", { state: state, ids: ids }, function (result) {
            if (result.successed) {
                $.messager.alert("提示", "修改成功！", "info");
                pharos.manager.gridReload();
            } else {
                $.messager.alert("提示", "修改失败！" + d.message, "error");
            }
        }, "json");
    }
    //设置分期
    function SetReturnRuleStage() {
        var rows = pharos.manager.selectItems();
        if (!rows) return;
        var ids = $.map(rows, function (item) {
            return item.Id;
        });
        openDialog600("设置分期", "@Url.Action("CreateRuleStage")" + "?returnRuleId=" + ids[0], false);
    }
</script>