using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Pharos.Utility;

namespace Pharos.Logic.BLL
{
    public class MemberRechargeBLL
    {
        private readonly MemberRechargeService _service = new MemberRechargeService();
        /// <summary>
        /// add
        /// </summary>
        /// <param name="_memberRecharge"></param>
        /// <returns></returns>
        public OpResult CreateRecharge(Entity.MemberRecharge _memberRecharge)
        {
            try
            {
                //complete base info
                _memberRecharge.CompanyId = CommonService.CompanyId;
                _memberRecharge.CreateDT = DateTime.Now;
                _memberRecharge.CreateUID = Sys.CurrentUser.UID;
                _memberRecharge.RechargeSN = DateTime.Now.ToString("yyyyMMddHHmmss");    //TODO: rechage SN rule
                _memberRecharge.AfterAmount = _memberRecharge.AfterAmount + _memberRecharge.RechargeAmount;//计算充值后
                //_memberRecharge.RechargeGiftId = ruleId;//规则id
                #region 作废赠送
                ////统计充值赠送相关
                //if (stageNumber > 0)
                //{//分期赠送 
                //    var year = DateTime.Now.Year;
                //    var month = DateTime.Now.Month;
                //    var giveDate = Convert.ToDateTime(year + "-" + month + "-" + returnDT);

                //    for (int i = 0; i < stageNumber; i++)
                //    {
                //        Entity.RechargeGiftsStage _stage = new Entity.RechargeGiftsStage()
                //        {
                //            CompanyId = CommonService.CompanyId,
                //            CardId = _memberRecharge.CardId,
                //            RechargeSN = _memberRecharge.RechargeSN,
                //            RuleId = ruleId,
                //            GiftProject = giftProject,//赠送项目 1：钱 2：积分
                //            GiftValue = stageAvg,//每期返还
                //            GiftDate = giveDate.AddMonths(i + 1).ToShortDateString(),
                //            State = 0,//0：未赠送；1：已赠送；2：已失效
                //            CreateDT = DateTime.Now,
                //            CreateUID = Sys.CurrentUser.UID
                //        };
                //        BaseService<Entity.RechargeGiftsStage>.Add(_stage, false);
                //    }
                //    //触发更新
                //    BaseService<Entity.RechargeGiftsStage>.Update(new Entity.RechargeGiftsStage());
                //}
                //else
                //{//即时赠送 
                //    _memberRecharge.AfterAmount = _memberRecharge.GivenAmount;
                //} 
                #endregion
                //更新会员卡金额、积分信息
                var membershipCard = BaseService<Entity.MembershipCard>.CurrentRepository.Entities.Where(o => o.CardSN == _memberRecharge.CardId && o.CompanyId == CommonService.CompanyId).FirstOrDefault();
                if (membershipCard != null)
                {
                    membershipCard.ReChargeTotal += _memberRecharge.RechargeAmount;
                    //membershipCard.GiveTotal += _memberRecharge.GivenAmount;
                    membershipCard.Balance += _memberRecharge.RechargeAmount;
                    //membershipCard.Integer += _memberRecharge.PresentExp;
                }
                new MembershipCardService().UpdateMembershipCard(membershipCard);

                return BaseService<Entity.MemberRecharge>.Add(_memberRecharge);
            }
            catch (Exception e)
            {
                throw;
            }
        }
        /// <summary>
        /// query data
        /// </summary>
        /// <param name="beginDate"></param>
        /// <param name="endDate"></param>
        /// <param name="keyWold"></param>
        /// <returns></returns>
        public object FindRechargePageList(DateTime? beginDate, DateTime? endDate, string keyWold,int keywordType, out int count)
        {
            return _service.FindRechargePageList(beginDate, endDate, keyWold,keywordType, out count);
        }
    }
}
