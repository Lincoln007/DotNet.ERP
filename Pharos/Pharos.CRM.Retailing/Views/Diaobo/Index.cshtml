@{
    ViewBag.Title = Pharos.Sys.SysConstPool.Page_Title;
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";
    ViewData.OpBtnInfo(new OpBtnInfo(addText: "新建调拨", hideDel:true,editText: "修改调拨",hideEdit:true));
}
@section search{
    <table class="table-toolbar">
        <tr>
            <td class="label-toolbar">
                <label>调拨状态：</label>
            </td>
            <td class="input-toolbar">
                @Html.RadioButtonList(ViewBag.states as List<SelectListItem>, "state", new { style = "height:26px;" })
            </td>
            <td class="label-toolbar">
                <label>关键词：</label>
            </td>
            <td class="input-toolbar">
                <input type="text" class="datacontrol easyui-textbox font-12" data-options="prompt:'货号/品名/条码'" name="searchText" />
            </td>
        </tr>
    </table>
}
@section toolbar
{
<a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-in-progress'" onclick="handler()">调拨处理</a>
<a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-ok'" onclick="receive()">收货确认</a>
<a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-revocation'" onclick="auditBack()">撤回调拨</a>
}

<script type="text/javascript">
    var curStoreId = '@ViewBag.CurStoreId';
    var viewurl = "@Url.Action("Detail")";
    pharos.manager.sortName = "CreateDT";
    pharos.manager.columns = [[
        { field: 'Id', checkbox: true },
        { field: 'OutStoreTitle', title: '调出分店', width: 120 },
        { field: 'InStoreTitle', title: '调入分店', width: 120 },
        { field: 'ProductCode', title: '货号', width: 150 },
        { field: 'Barcode', title: '条形码', width: 150 },
        { field: 'Title', title: '品名', width: 150 },
        { field: 'BrandTitle', title: '品牌', width: 80 },
        { field: 'SubUnit', title: '单位', width: 50 },
        { field: 'OrderQuantity', title: '申请量', width: 60 },
        { field: 'DeliveryQuantity', title: '配送量', width: 60 },
        { field: 'ActualQuantity', title: '收货量', width: 60 },
        { field: 'CreateDT', title: '申请时间', width: 120 },
        { field: 'StateTitle', title: '状态', width: 60 }
    ]];
    var btns = [{
        text: '退回调拨请求',
        iconCls: 'icon-ok',
        width:'130px',
        handler: function () {
            //window.top.$('#formDiv iframe')[0].contentWindow.$('#State').val("3");
            window.top.$('#formDiv iframe')[0].contentWindow.$('#State').val("3");
            window.top.$('#formDiv iframe')[0].contentWindow.$('#DeliveryQuantity').numberbox("disableValidation");
            window.top.$('#formDiv iframe')[0].contentWindow.$('.default-form form').submit();
        }
    }, {
        text: '保存并配送',
        width: '120px',
        iconCls: 'icon-ok',
        handler: function () {
            window.top.$('#formDiv iframe')[0].contentWindow.$('#State').val("2");
            window.top.$('#formDiv iframe')[0].contentWindow.$('.default-form form').submit();
        }
    },{
        text: '关闭',
        iconCls: 'icon-cancel',
        handler: function () { pharos.easyui.dialog.topClose("formDiv"); }
    }];
    var btns2 = [{
        text: '确定收货',
        width: '120px',
        iconCls: 'icon-ok',
        handler: function () {
            //window.top.$('#formDiv iframe')[0].contentWindow.$('#State').val("4");
            window.top.$('#formDiv iframe')[0].contentWindow.$('.default-form form').submit();
        }
    }, {
        text: '关闭',
        iconCls: 'icon-cancel',
        handler: function () { pharos.easyui.dialog.topClose("formDiv"); }
    }];
    pharos.manager.addItem = function () {
        this.Id = "";
        openDialog600(this.addText,this.editurlNocache());
        window.top.$("#lbsave .l-btn-text").width(110).html("保存并提交");
    }
    pharos.manager.editItem = function (id, row) {
        if (row.State == "3") {
            var url = viewurl + "?Id=" + row.Id
            //openDialog600("查看调拨", viewurl, false);
            openWin({ 'title': "查看调拨", 'width': 600, 'height': 400, hideSave: true, 'url': url });
        }
    }
    function editBefore(row) {
        if (row.State == "3") {
            return true;
        }
        return false;
    }
    function handler() {
        var rows = pharos.manager.selectItems();
        if (rows == null) return;
        $.each(rows, function (i, r) {
            if (r.StateTitle != "调拨中") {
                $.messager.alert("提示", "只有调拨中才能调拨处理。");
                rows = null;
                return false;
            }
        });
        if (rows == null) return;
        if (rows[0].InStoreId == curStoreId) {
            $.messager.alert("提示", "无法处理本门店提交的调拨申请。");
            return false;
        }
        var parms = { title: '调拨处理', buttons: btns, url: '@Url.Action("Handler")?Id=' + rows[0].Id };
        openWin(parms);
    }
    function receive() {
        var rows = pharos.manager.selectItems();
        if (rows == null) return;
        $.each(rows, function (i, r) {
            if (r.StateTitle != "已配送") {
                $.messager.alert("提示", "只有已配送才能收货确认!");
                rows = null;
                return false;
            }
        });
        if (rows) {
            var parms = { title: '收货确认', buttons: btns2, url: '@Url.Action("Receiver")?Id=' + rows[0].Id }; openWin(parms);
        }
    }
    function auditBack() {
        var rows = pharos.manager.selectItems();
        if (rows == null) return;
        $.each(rows, function (i, r) {
            if (r.StateTitle == "已撤回" || r.StateTitle == "已收货") {
                $.messager.alert("提示", "只有调拨中或已配送才能撤回!");
                rows = null;
                return false;
            }
        });
        if (rows == null) return;
        if (rows[0].InStoreId != curStoreId) {
            $.messager.alert("提示", "只能撤回本门店提交的调拨申请。");
            return false;
        }
        $.messager.confirm("提示", "是否确定撤回调拨?", function (r) {
            if (!r) return;
            var ids = $.map(rows, function (item) {
                return item.Id;
            }).join();
            $.post("@Url.Action("ReBack")", { Ids: ids }, function () {
                pharos.manager.gridReload();
            })
        });

    }
</script>