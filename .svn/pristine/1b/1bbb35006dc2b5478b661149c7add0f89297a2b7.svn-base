using Pharos.AutoUpdateTools;
using Pharos.Wpf.ViewModelHelpers;
using System;
using System.Reflection;
using System.Xml.Serialization;

namespace Pharos.POS.Retailing.Models.ViewModels
{
    public class ServicesConfiguration : BaseViewModel, ISettingsItem
    {
        string headerXamlPath = "Templates/DefaultTabControlHeaderTemplate.xaml";
        [XmlIgnore]
        public string HeaderXamlPath
        {
            get
            {
                return headerXamlPath;
            }
            set
            {
                headerXamlPath = value;
                this.OnPropertyChanged(o => o.HeaderXamlPath);
            }
        }

        string xamlPath = "Templates/ServicesConfigurationTemplate.xaml";
        [XmlIgnore]
        public string XamlPath
        {
            get
            {
                return xamlPath;
            }
            set
            {
                xamlPath = value;
                this.OnPropertyChanged(o => o.XamlPath);
            }
        }

        string header = "系统配置";
        [XmlIgnore]
        public string Header
        {
            get
            {
                return header;
            }
            set
            {
                header = value;
                this.OnPropertyChanged(o => o.Header);
            }
        }
        [XmlIgnore]
        public string CurrentVersion
        {
            get
            {
                Assembly mainAssembly = Assembly.GetEntryAssembly();
                return mainAssembly.GetName().Version.ToString();
            }
        }

        bool enableAutoDataSync = true;
        public bool EnableAutoDataSync
        {
            get
            {
                if (EnableDataSync)
                    return enableAutoDataSync;
                return EnableDataSync;
            }
            set
            {
                enableAutoDataSync = value;
                this.OnPropertyChanged(o => o.EnableAutoDataSync);
            }
        }

        bool enableDataSync = true;
        public bool EnableDataSync
        {
            get
            {
                return enableDataSync;
            }
            set
            {
                enableDataSync = value;
                this.OnPropertyChanged(o => o.EnableDataSync);
                this.OnPropertyChanged(o => o.EnableAutoDataSync);
            }
        }


        string dataSyncServerIp = "127.0.0.1";
        public string DataSyncServerIp
        {
            get
            {
                return dataSyncServerIp;
            }
            set
            {
                dataSyncServerIp = value;
                this.OnPropertyChanged(o => o.DataSyncServerIp);
            }
        }

        int dataSyncServerPort = 2020;
        public int DataSyncServerPort
        {
            get
            {
                return dataSyncServerPort;
            }
            set
            {
                dataSyncServerPort = value;
                this.OnPropertyChanged(o => o.DataSyncServerPort);
            }
        }

        [XmlIgnore]
        public GeneralCommand<object> OnceDataSyncCommand
        {
            get
            {
                return new GeneralCommand<object>((o1, o2) =>
                {
                });
            }
        }

        bool serverPreferred;
        public bool ServerPreferred
        {
            get
            {
                return serverPreferred;
            }
            set
            {
                serverPreferred = value;
                this.OnPropertyChanged(o => o.ServerPreferred);
            }
        }

        string localHost = "http://localhost";
        [XmlIgnore]
        public string LocalHost
        {
            get { return string.Format("{0}:{1}", localHost, LocalPort); }
        }
        string localPort = "4588";
        public string LocalPort
        {
            get
            {
                return localPort;
            }
            set
            {
                localPort = value;
                this.OnPropertyChanged(o => o.LocalPort);
            }
        }


        string serverHost = "http://192.168.10.122:8012";
        public string ServerHost
        {
            get
            {
                return serverHost;
            }
            set
            {
                serverHost = value;
                this.OnPropertyChanged(o => o.ServerHost);
            }
        }

        public string UpdatePath { get; set; }

        [XmlIgnore]
        public GeneralCommand<object> UpdateCommand
        {
            get
            {
                return new GeneralCommand<object>((o1, o2) =>
                {
                    if (string.IsNullOrEmpty(UpdatePath)) 
                    {
                        Toast.ShowMessage("无更新配置！", CurrentWindow);
                        return;
                    }
                    AutoUpdater.Start(UpdatePath);
                    AutoUpdater.CheckForUpdateEvent += AutoUpdaterOnCheckForUpdateEvent;
                    AutoUpdater.OpenDownloadPage = true;

                    AutoUpdater.LetUserSelectRemindLater = false;
                    AutoUpdater.RemindLaterTimeSpan = RemindLaterFormat.Days;
                    AutoUpdater.RemindLaterAt = 2;
                });
            }
        }

        private void AutoUpdaterOnCheckForUpdateEvent(UpdateInfoEventArgs _args)
        {
            CurrentWindow.Dispatcher.Invoke(new Action<UpdateInfoEventArgs>((args) =>
            {
                if (args != null)
                {
                    if (args.IsUpdateAvailable)
                    {
                        Confirm.ShowMessage(string.Format("发现新版本{0}，程序当前版本{1}，是否更新到最新版本？", args.CurrentVersion, args.InstalledVersion), CurrentWindow, (o) =>
                        {
                            if (o == ConfirmMode.Confirmed)
                            {
                                try
                                {
                                    AutoUpdater.DownloadUpdate();
                                }
                                catch (Exception exception)
                                {
                                    throw exception;
                                }
                            }
                        });
                    }
                    else
                    {
                        Toast.ShowMessage("未发现新版本，无需更新！", CurrentWindow);
                    }
                }
                else
                {
                    Toast.ShowMessage("程序更新发生问题，请检查是否联网！", CurrentWindow);
                }
            }), _args);
        }
        [XmlIgnore]
        public GeneralCommand<object> SaveCommand
        {
            get
            {
                return new GeneralCommand<object>((o1, o2) =>
                {
                    try
                    {
                        Global.MachineSettings.Save();
                        Toast.ShowMessage("保存成功！", CurrentWindow);
                    }
                    catch (Exception ex)
                    {
                        throw ex;
                    }
                });
            }
        }

        internal void Reload(ServicesConfiguration servicesConfiguration)
        {
            LocalPort = servicesConfiguration.LocalPort;
            ServerHost = servicesConfiguration.ServerHost;
            ServerPreferred = servicesConfiguration.ServerPreferred;
            DataSyncServerPort = servicesConfiguration.DataSyncServerPort;
            DataSyncServerIp = servicesConfiguration.DataSyncServerIp;
            EnableDataSync = servicesConfiguration.EnableDataSync;
            EnableAutoDataSync = servicesConfiguration.EnableAutoDataSync;
            UpdatePath = servicesConfiguration.UpdatePath;
        }
    }
}
