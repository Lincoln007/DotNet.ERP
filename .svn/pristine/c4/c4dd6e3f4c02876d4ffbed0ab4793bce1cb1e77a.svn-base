@{
    ViewBag.Title = Pharos.Sys.SysConstPool.Page_Title;
    Layout = "~/Views/Shared/_FormLayout.cshtml";
}
<div class="default-form">
    @using (Html.BeginForm("SaveTuiZhengDan", "Tuihuan"))
    {
        @Html.Hidden("insertolded")
        <div class="content">
            <table width="100%" height="50px">
                <tr>
                    <td width="64" class="name">流水号：</td>
                    <td width="180">@Html.DropDownList("payno", new List<SelectListItem>(), new { @class = "easyui-combobox", data_options = "mode:'remote',valueField:'paysn',textField:'title',loader:comboload,onChange:paynoChange" })</td>
                    <td width="64" class="name">退货理由：</td>
                    <td width="180">@Html.DropDownList("reason", ViewBag.reasons as List<SelectListItem>, new { @class = "easyui-combobox", data_options = "editable:false" })</td>
                    <td width="64" class="name">退还金额：</td>
                    <td class="180">@Html.TextBox("retprice", null, new { @class = "easyui-numberbox", data_options = "width:100,required:true,precision:2" })</td>
                </tr>
            </table>
            <table class="easyui-datagrid" id="gridOld"
                   data-options="url:'@Url.Action("FindOldPageList")',idField:'Barcode',checkOnSelect:false,border:true,rownumbers:true,fit:false,fitColumns:true,pagination:false,onLoadSuccess:gridLoadSuccess">
                <thead>
                    <tr>
                        <th data-options="field:'Barcode'" width="150">条码</th>
                        <th data-options="field:'Title'" width="150">品名</th>
                        <th data-options="field:'Number',editor:{type:'numberspinner',options:{required:true,min:1}}" width="80">数量</th>
                        <th data-options="field:'ReturnedNumber',hidden:true,styler:function(){return 'color:red';}" width="100">已退换数量</th>
                        <th data-options="field:'TradingPrice'" width="90">售价</th>
                        <th data-options="field:'Total',formatter:function(value,row,index){return row.TradingPrice*row.Number;}" width="90">小计</th>
                    </tr>
                </thead>
            </table>
        </div>
    }
</div>
<script type="text/javascript">
    var $dgold = null;
    $(function () {
        $dgold = $("#gridOld");
    });
    var comboload = function (param, success, error) {
        //获取输入的值
        var q = param.q || "";
        //此处q的length代表输入多少个字符后开始查询
        if (q.length <= 1) return false;
        $.ajax({
            url: "@Url.Action("GetSaleOrderInput")",
            type: "post",
            data: {
                //传值，还是JSON数据搜索
                searchName: q
            },
            //重要，如果写jsonp会报转换错误，此处不写都可以
            dataType: "json",
            success: function (data) {
                comboRows = data.rows;
                //关键步骤，遍历一个MAP对象
                var items = $.map(data.rows, function (item) {
                    return { paysn: item.PaySN, title: item.PaySN };
                });
                //执行loader的success方法
                success(items);
            },    //异常处理
            error: function (xml, text, msg) {
                error.apply(this, arguments);
            }
        });
    }
    function paynoChange(paysn, old) {
        $.post("@Url.Action("GetSaleDetailByPaySN")", { paysn: $("#payno").combobox("getValue"), t: Math.random() }, function (json) {
            $dgold.datagrid("loadData", json);
            calRetPrice();
        }, "json");
    }
    function gridLoadSuccess(data) {
        var isReturned = false;
        $.each(data.rows, function (i, n) {
            if (n.HasReturned > 0) isReturned = true;
        })
        if (isReturned) $dgold.datagrid('showColumn', 'ReturnedNumber');
        else $dgold.datagrid('hideColumn', 'ReturnedNumber');
    }
    function SaveBefore() {
        //需保证编辑器输入时就验证正确
        var checkedRows = $dgold.datagrid('getRows');
        if (checkedRows.length <= 0) {
            $.messager.alert("提示", "退换商品信息不能为空!"); return false;
        }
        $("#insertolded").val(JSON.stringify(checkedRows));
        return true;
    }

    //计算退还金额
    function calRetPrice() {
        var retprice = 0;
        $.each($dgold.datagrid('getRows'), function (i, row) {
            retprice += (row.TradingPrice * row.Number);
        })
        $("#retprice").numberbox("setValue", retprice);
    }
</script>