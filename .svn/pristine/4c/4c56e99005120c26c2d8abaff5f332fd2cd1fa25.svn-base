using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data;
using Pharos.Utility;
using Pharos.Logic.Entity;
using Pharos.Logic.DAL;

namespace Pharos.Logic.BLL
{
    public class MakingCouponCardBLL : BaseService<MakingCouponCard>
    {
        private MakingCouponCardDAL _dal = new MakingCouponCardDAL();
        /// <summary>
        /// 制作优惠券：新增或修改
        /// </summary>
        /// <param name="model"></param>
        /// <returns></returns>
        public OpResult SaveOrUpdate(MakingCouponCard model)
        {
            OpResult result = new OpResult();
            if (model.Id == 0)
            {
                model.CreateDT = DateTime.Now;
                model.CreateUID = Sys.CurrentUser.UID;
                model.CompanyId = CommonService.CompanyId;
                model.State = 0;
                var firstBatchSN = DateTime.Now.ToString("yyMMdd") + "01";
                var firstBatchToInt = long.Parse(firstBatchSN);
                var min = DateTime.Parse(DateTime.Now.ToShortDateString());
                var max = min.AddDays(1);
                var batchListCount = BaseService<MakingCouponCard>.FindList(o => o.CreateDT >= min && o.CreateDT < max).Count();
                model.BatchSN = (firstBatchToInt + batchListCount).ToString();//批次：6位日期 + 2位序号,示例：16081601
                result = BaseService<MakingCouponCard>.Add(model);
                return result;
            }
            else
            {
                return result;
                //return BaseService<MakingCouponCard>.Update(model);
            }

        }

        //获取制作优惠券列表
        public DataTable FindCreateCouponPageList(Paging paging, int couponType, int couponFrom, short state, string storeIds, string expiryStart, string expiryEnd, string createUID)
        {
            return _dal.FindCreateCouponPageList(paging, couponType, couponFrom, state, storeIds, expiryStart, expiryEnd, createUID);
        }

        /// <summary>
        /// 获取品类列表
        /// </summary>
        /// <param name="recordCount">总数</param>
        /// <returns>品类列表</returns>
        public static object LoadCategoryList(out int recordCount)
        {
            recordCount = 0;

            var dal = new Pharos.Logic.DAL.MakingCouponCardDAL();
            var dt = dal.GetCategoryList();
            var list = dt.AsEnumerable().Select(dr => new
            {
                Id = dr["Id"],
                CategorySN = dr["CategorySN"],
                BigCategoryTitle = dr["BigCategoryTitle"],
                MidCategoryTitle = dr["MidCategoryTitle"],
                SubCategoryTitle = dr["SubCategoryTitle"]
            }).ToList();
            recordCount = list.Count;
            return list;
        }


    }
}
