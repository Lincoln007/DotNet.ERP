@{
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";
    ViewData.OpBtnInfo(new OpBtnInfo(hideAdd: true, hideEdit: true, hideDel: true));
}
@section search{
<table class="table-toolbar">
    <tr>
        <td class="label-toolbar">
            <label>业务员：</label>
        </td>
        <td class="input-toolbar">
            @Form.Combobox("AssignerUID", ViewBag.user as List<SelectListItem>, dataOptions: "editable:false,panelMaxHeight:200")
        </td>
        <td class="label-toolbar">
            <label>客户类型：</label>
        </td>
        <td class="input-toolbar">
            @Html.DropDownList("BusinessModeId", ViewBag.ModeId as List<SelectListItem>, new { @class = "easyui-combobox datacontrol", data_options = "novalidate:true,editable: false,width:120" })
        </td>
        <td class="label-toolbar">
            <label>跟踪状态：</label>
        </td>
        <td class="input-toolbar">
            @Html.DropDownList("TrackStautsId", ViewBag.TrackStautsId as List<SelectListItem>, new { @class = "easyui-combobox", data_options = "novalidate:true, editable: false,width:120" })
        </td>
        <td class="label-toolbar">
            <label>登记日期：</label>
        </td>
        <td class="input-toolbar">
            <input name="CreateDT_begin" id="" class="Wdate datacontrol" style="width: 100px;" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" />
        </td>
        <td class="label-toolbar">
            <label style="width:10px;margin-right:3px;position:relative;top:-4px;">-</label>
        </td>
        <td class="input-toolbar">
            <input name="CreateDT_end" id="" class="Wdate datacontrol" style="width: 100px;" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" />
        </td>

    </tr>

    <tr class="s_tr">
        <td class="label-toolbar">
            <label>区&nbsp;&nbsp;&nbsp;域：</label>
        </td>
        <td class="input-toolbar">
            <input id="Province" name="CurrentProvinceId" class="easyui-combobox" />
        </td>
        <td class="label-toolbar">
            <label style="width:10px;margin-right:3px;position:relative;top:-4px;">-</label>
        </td>
        <td class="input-toolbar">
            <input id="City" name="CurrentCityId" class="easyui-combobox" />
        </td>

        <td class="label-toolbar">
            <label>经营范围：</label>
        </td>
        <td class="input-toolbar">
            @Html.DropDownList("BusinessScopeId", ViewBag.BusinessScopeId as List<SelectListItem>, new { @class = "easyui-combobox", data_options = "novalidate:true, editable: false,width:120" })
        </td>

        <td class="label-toolbar">
            <label>关键字：</label>
        </td>
        <td class="input-toolbar" style="padding-right:10px;">
            @Html.DropDownList("keywordType", new List<SelectListItem>() { new SelectListItem() { Text = "按商户号", Value = "0" }, new SelectListItem() { Text = "按客户名称", Value = "1" }, new SelectListItem() { Text = "按联系人", Value = "2" }, new SelectListItem() { Text = "按电话或手机", Value = "3" } }, new { @class = "easyui-combobox datacontrol", data_options = "novalidate:true, editable: false,width:120" })
        </td>
        <td class="input-toolbar">
            <input name="keyword" class="datacontrol easyui-textbox font-12" placeholder="" data-options="prompt:'关键字',width:231" />
        </td>
    </tr>

</table>
}
@section toolbar
{
    <a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-import'" onclick="openDialogNew('excel文件导入', '@Url.Action("Import")' , 1000, 560, true, true, btns);">选择导入</a>
    <a href="#" id="btnExcel" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-export'" onclick="loadData()">载入未完成数据</a>
    <a href="#" id="btnExcel" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-suspend'" onclick="loadData()">移除所选项</a>
    <a href="#" id="btnExcel" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-export'" onclick="sureImport()">确定导入</a>
    <a href="#" id="" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-delete'" onclick="clearImport()">清空预览</a>
}
<script type="text/javascript">
    var btns = [{
        text: '导 入',
        iconCls: 'icon-ok',
        id: "lbsave",
        handler: function () {
            window.top.$('#formDiv iframe')[0].contentWindow.$('.messager-button .l-btn-small').click();
            window.top.$('#formDiv iframe')[0].contentWindow.$('.default-form form').submit();
        }
    }, {
        text: '预 览',
        iconCls: 'icon-ok',
        handler: function () {
            pharos.easyui.dialog.topClose("formDiv");
            pharos.manager.gridReload(); 
        }
    }];

    pharos.manager.geturl = '@Url.Action("SaleDataMoveList")';
    pharos.manager.pagination = false;
    pharos.manager.showFooter = true;
    pharos.manager.frozenColumns = [[
        { field: 'Id', checkbox: true },
        { field: 'FullName', title: '业务员', editor: { type: 'text', required: true }, width: 60 },
        { field: 'Title', title: '跟进状态', editor: { type: 'text', required: true }, width: 80 },
        {
            field: 'Status', title: '状态', editor: { type: 'text', required: true }, width: 60, formatter: function (value, row, index) {
                if (value == "0") {
                    return "未审核";
                } else if (value == "1") {
                    return "已审核";
                } else {
                    return "无效";
                }
            }
        },
        { field: 'CID', title: '商户号', editor: { type: 'text', required: true }, width: 60 },
        { field: 'khTitle', title: '客户名称', editor: { type: 'text', required: true }, width: 100 }
    ]];

    pharos.manager.columns = [[
        { field: 'khType', title: '客户类型', editor: { type: 'text', required: true }, width: 100 },
        { field: 'city', title: '城市', editor: { type: 'text', required: true }, width: 80 },
        { field: 'tType', title: '客户分类', editor: { type: 'text', required: true }, width: 100 },
        { field: 'bCategory', title: '经营类别', editor: { type: 'text', required: true }, width: 400 },
        { field: 'ExistStoreNum', title: '门店数量', editor: { type: 'text', required: true }, width: 120 },
        {
            field: 'oList', title: '采购需求', editor: { type: 'text', required: true }, width: 200, formatter: function (value, row, index) {
                if (value == "" || value == null) {
                    return "无";
                }
                else {
                    var v = value.replace(/,/g, '<br />');
                    return v;
                }
            }
        },
        { field: 'LinkMan', title: '联系人', editor: { type: 'text', required: true }, width: 90 },
        { field: 'MobilePhone', title: '电话/手机', editor: { type: 'text', required: true }, width: 110 },
        { field: 'CreateDT', title: '登记时间', editor: { type: 'text', required: true }, width: 150 },
        { field: 'cFullName', title: '登记人', editor: { type: 'text', required: true }, width: 90 }
    ]];

    var num = 0,load=0;
    function sureImport() {
        var rows = pharos.manager.$dg.datagrid("getRows");
        if (rows.length <= 0) {
            $.messager.alert("提示", "请先选择文件预览!"); return;
        }
        if (num > 0) return;
        $.messager.confirm("提示", "请先确认数据无误，正式导入后将不能撤消，是否继续？", function (r) {
            if (!r) return;
            $("#loading").show().find("div").html("正在导入，请稍待。。。");
            $.post("@Url.Action("SureImport")", { t: Math.random() }, function (json) {
                num = 0;
                load = 0;
                $("#loading").hide();
                if (json.successed) {
                    $.messager.alert("提示", "导入成功!");
                    pharos.manager.gridReload();
                } else {
                    $.messager.alert("提示", "导入失败!" + json.message);
                }
            });
            num++;
        })
    }
    pharos.manager.loadSuccess = function (data) {
        //pharos.manager.$dg.datagrid("autoMergeCellsGroupby", { groupby: 'ApiOrderSN', columns: ['ApiOrderSN', 'SaleDate', 'Type', 'ApiTitle', 'PreferentialPrice', 'Change', 'WipeZero', 'TotalAmount', 'Receive'] });
        if (data.rows.length <= 0 && load > 0) $.messager.alert("提示", "未发现数据，请选择导入!");
        load++;
    }
    function clearImport() {
        $.messager.confirm("提示", "是否确定清空预览？", function (r) {
            if (!r) return;
            $.post("@Url.Action("ClearImport")", { t: Math.random() }, function () {
                load = 0;
                pharos.manager.gridReload();
            })
        });
    }
    function loadData() {
        pharos.manager.gridReload();
    }
    function closeDialog() {

    }
</script>