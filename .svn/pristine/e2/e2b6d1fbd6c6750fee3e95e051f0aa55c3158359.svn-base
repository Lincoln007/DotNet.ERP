@model Pharos.Logic.OMS.Entity.Plans
@{
    ViewBag.Title = "Save";
    Layout = "~/Views/Shared/_FormLayout.cshtml";

}
<link href="~/Content/iconfont/iconfont.css" rel="stylesheet" />
<style>.date{display:none} .table-form tr{height:34px;} textarea{line-height:20px!important;} .showb{display:block}</style>
<div class="default-form">
    @using (Html.BeginForm("SavePlan", "Plan", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.HiddenFor(o => o.Id)
        <div class="content">
            <div id="tt1" class="easyui-tabs" data-options="fit:true,border:true,onSelect:function(title,index){}" style="height:340px;">
                <div title="计 划">
                    <table class="table-form" width="100%">
                        <tr>
                            <td class="name">计划类型：</td>
                            <td class="input">@Html.RadioButtonListFor(o => o.Type, ViewBag.types as List<SelectListItem>)</td>
                        </tr>
                        <tr>
                            <td class="name">计划日期：</td>
                            <td class="input">
                                <span class="date">@Html.TextBoxFor(o => o.StartDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100",style="width:135px;" })</span>
                                <span class="date">@Html.TextBoxFor(o => o.StartDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;" }) - @Html.TextBoxFor(o => o.EndDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;" })</span>
                                <span class="date">@Html.TextBoxFor(o => o.StartDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;" }) - @Html.TextBoxFor(o => o.EndDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;" })</span>
                                <span class="date">@Html.TextBoxFor(o => o.StartDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;", onclick = "WdatePicker({ dateFmt:'yyyy-MM'})" }) - @Html.TextBoxFor(o => o.EndDate, new { @class = "easyui-validatebox Wdate", data_options = "required:true,width:100", style = "width:135px;", onclick = "WdatePicker({ dateFmt:'yyyy-MM'})" })</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="name">执行人：</td>
                            <td class="input">@Form.Combobox("AssignerUID", ViewBag.users as List<SelectListItem>, multiple: false, dataOptions: "editable:false,value:'"+ViewData.Eval("AssignerUID") +"'")</td>
                        </tr>
                        <tr>
                            <td class="name">详细计划：</td>
                            <td class="input">@Html.TextAreaFor(o => o.Content, new { @class = "easyui-validatebox", data_options = "required:true,validType:'length[1,2000]'", style = "width:440px;height:160px;", maxlength = 2000 })
                                <div>限长2000个字，还可以输入 <span style="color:#FF0000;" id="s_num">2000</span> 个字</div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div title="附 件">
                    <table width="100%">
                        <tr>
                            <td colspan="2">
                                <table class="easyui-datagrid" id="grid"
                                       data-options="url:'@Url.Action("LoadFileList")',queryParams:{id:'@Model.Id'},showFooter:false,border:true,rownumbers:true,fit:false,fitColumns:false,pagination:false,singleSelect:true,onLoadError:loadError,height:260">
                                    <thead>
                                        <tr>
                                            <th data-options="field:'Name',formatter:attachName" width="350">附件名称</th>
                                            <th data-options="field:'FileSizeTitle'" width="150">大小</th>
                                            <th data-options="field:'Editor',formatter:operation" width="150">操作</th>
                                        </tr>
                                    </thead>
                                </table>
                            </td>
                        </tr>
                        @if (Request["isdetail"].IsNullOrEmpty())
                        {
                        <tr>
                            <td><input type="text" class="easyui-filebox" name="file1" data-options="buttonText:'选择文件',prompt:'请选择文件...',missingMessage:'请选择文件',onChange:fileChange" style="width:250px;" /></td>
                            <td>说明：单个文件上限10M，每次最多上传8个文件。</td>
                        </tr>
                        }
                    </table>
                </div>
                <div title="总 结">
                    <table class="table-form" width="100%" style="margin-top:10px;">
                        <tr>
                            <td class="name">执行人总结：</td>
                            <td class="input">
                                @Html.TextAreaFor(o => o.Summary, new { @class = "easyui-validatebox", data_options = "validType:'length[1,500]'", style = "width:440px;height:120px;", maxlength = 500 })
                                <div style="margin-bottom:5px;">限长500个字，还可以输入 <span style="color:#FF0000;" id="s_num2">500</span> 个字</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="name">上级领导：</td>
                            <td class="input">@Form.Combobox("LeaderUID", ViewBag.users as List<SelectListItem>,multiple:false, dataOptions: "editable:false", controlWidth: 200)</td>
                        </tr>
                        @if ((Model.Replys != null && Model.Replys.Any()) || !Request["isdetail"].IsNullOrEmpty())
                        {
                        <tr>
                            <td class="name">上级批复：</td>
                            <td class="input">
                                @Html.TextArea("Replys[0].Content",Model.Replys==null?"":Model.Replys.Select(o=>o.Content).FirstOrDefault(), new { @class = "easyui-validatebox", style = "width:440px;height:100px;" })
                            </td>
                        </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
    }
</div>
<div id="win" class="easyui-dialog" data-options="title:'预览',cache:false,modal:true,width:750,height:350,closed:true,collapsible:false,minimizable:false,maximizable:false"></div>
<script type="text/javascript">
    $(function () {
        dispDate($("[name='Type']:checked").parent().index());
        $("#Content").keyup(function (e) {
            var maxlen = $(this).attr("maxlength");
            var len = $(this).val().length;
            $("#s_num").html(Number(maxlen) - len);
        })
        $("#Summary").keyup(function (e) {
            var maxlen = $(this).attr("maxlength");
            var len = $(this).val().length;
            $("#s_num2").html(Number(maxlen) - len);
        })
        var tab = "@Request["isdetail"]";
        if(tab)
            $('#tt1').tabs('select', "总 结");

        var luid = '@Model.LeaderUID';
        $("#LeaderUID_0").combobox("setValues", luid.split(','));
    });
    function dispDate(i){
        $(".date").removeClass("showb").eq(i).addClass("showb");
    }
    $("[name='Type']").click(function (e) {
        var idx= $(this).parent().index();
        dispDate(idx);
    });
    var btns=[{
        text: '关闭',
        iconCls: 'icon-cancel',
        handler: function () {
            $('#win').dialog('close');
        }
    }];
    function attachName(value, row, index) {
        return "<i class='" + row.FileFontIcon + "'></i>"+value;
    }
    function operation(value, row, index) {
        var title = "";
        if (row.Id)
            title += "<a href='@Url.Action("DownLoad")?id="+row.Id+"'>下载</a> &nbsp; &nbsp;";
        title += "<a href='javascript:void(0)' onclick=\"preview('" + row.NewName + "')\">预览</a> &nbsp; &nbsp;" +
            "<a href='javascript:void(0)' onclick=\"removeFile('" + row.NewName + "')\">移除</a>";
        return title;
    }
    function preview(name) {
        var url="@Url.Action("Preview")?id=@Model.Id&name=" + name;
        //var cont = "<iframe src='" + url + "' width='100%' height='99%' frameborder='0' />";
        //$("#win").dialog({ content: cont }).dialog("open");
        window.open(url)
    }
    function removeFile(name) {
        $.messager.confirm("提示", "是否确定移除该文件?", function (r) {
            if (!r) return;
            $.post("@Url.Action("RemoveFile")", { id: '@Model.Id', name: name, t: Math.random() }, function (json) {
                if (json.successed) {
                    $("#grid").datagrid("reload");
                } else {
                    var msg = json.descript ? "" : json.message;
                    $.messager.alert('错误', '移除失败！' + msg, "error", function () {
                    });
                }
            }, "json");
        })
    }
    function SaveBefore() {
        $(".date:hidden").find("input").each(function (i, r) {
            $(r).validatebox("disableValidation");
            $(r).attr("disabled", "disabled");
        });
        $(".showb").find("input").each(function (i, r) {
            $(r).validatebox("enableValidation");
            $(r).removeAttr("disabled");
        });
        return true;
    }
    function fileChange(nv,ov) {
        if (!nv) return;
        var form = new FormData($('form')[0]);
        $.ajax({
            url: "@Url.Action("FileUpload")",
            type: 'post',
            data: form,//序列化表单
            processData: false,
            contentType: false,
            cache: false,
            success: function (data) {
                var json = $.parseJSON(data);
                if (json.successed) {
                    $("#grid").datagrid("reload");
                } else {
                    var msg = json.descript ? "" : json.message;
                    $.messager.alert('错误', '操作失败！' + msg, "error", function () {
                    });
                }
            },
            error: function (e) {
                alert(e.statusText);
            }
        });
    }
</script>
