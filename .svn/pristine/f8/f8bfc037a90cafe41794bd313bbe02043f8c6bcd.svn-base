using System.Web.Mvc;
using System.ComponentModel.DataAnnotations;
using System.Collections.Generic;
using System.Linq;
using Pharos.Utility;
using Pharos.Logic;
using Pharos.Logic.BLL;
using Pharos.Utility.Helpers;
using System;
using Pharos.Sys.BLL;
using Pharos.Sys;

namespace Pharos.CRM.Retailing.Controllers
{
    public class AccountController : Controller
    {
        public ActionResult Login()
        {
            //if (CurrentUser.IsLogin)
            //{
            //    //已登录，则直接进入主界面
            //    return Redirect(Url.Action("Index", "Home"));
            //}
            //1为单商户版本，其他值为多商户版本
            string ver = Pharos.Utility.Config.GetAppSettings("ver");
            //单商户版本
            if (ver == "1")
            {
                var user = new UserLogin();
                if (Cookies.IsExist("remuc"))
                {
                    user.UserName = Cookies.Get("remuc", "_uname");
                    user.UserPwd = Cookies.Get("remuc", "_pwd");
                    user.RememberMe = true;
                }
                return View(user);
            }
            //多商户版本
            else
            {
                return Logins();
            }

            
        }

        [HttpPost]
        public ActionResult Login(UserLogin user)
        {

            //1为单商户版本，其他值为多商户版本
            string ver = Pharos.Utility.Config.GetAppSettings("ver");
            //单商户版本
            if (ver == "1")
            {
                if (!ModelState.IsValid) return View(user);
                var op = Authorize.LoinValidator(CommonService.CompanyId);
                if (!op.Successed)
                {
                    ViewBag.msg = op.Message;
                    return View(user);
                }

                var pwd = Pharos.Utility.Security.MD5_Encrypt(user.UserPwd);
                var obj = UserInfoService.Find(o =>o.CompanyId==CommonService.CompanyId && o.LoginName == user.UserName && o.LoginPwd == pwd && o.Status == 1);
                if (obj == null)
                {
                    ViewBag.msg = "帐户或密码输入不正确!";
                    return View(user);
                }
                new Sys.CurrentUser().Login(obj, user.RememberMe);
                return Redirect(Url.Action("Index", "Home"));
            }
            //多商户版本
            else
            {
                return Logins(user);
            }

        }

        #region 个人信息
        public ActionResult UserInfo()
        {
            var userBll= new Pharos.Sys.BLL.SysUserInfoBLL();
            var model = userBll.GetModelByUID(Sys.CurrentUser.UID);
            List<SelectListItem> storeRoles = null;
            if(!Sys.CurrentUser.StoreId.IsNullOrEmpty())
            {
                var user= userBll.GetStoreUser(Sys.CurrentUser.StoreId).FirstOrDefault(o=>o.UID==Sys.CurrentUser.UID);
                if(user!=null && !user.OperateAuth.IsNullOrEmpty())
                {
                    var auths = user.OperateAuth.Split('|');
                    storeRoles = new List<SelectListItem>();
                    foreach(var o in auths)
                    {
                        if(o.IsNullOrEmpty()) continue;
                        if(o.StartsWith(Sys.CurrentUser.StoreId+","))
                        {
                            var role = o.Substring(o.LastIndexOf(',') + 1);
                            storeRoles.Add(new SelectListItem() { 
                                Value=role,Text=role=="1"?"店长":role=="2"?"营业员":role=="3"?"收银员":"数据维护",Selected=true
                            });
                        }
                    }
                }
            }
            ViewBag.BumenTitle = new Pharos.Sys.BLL.SysDepartmentBLL().GetModelByDepId(model.BumenId).Title;
            ViewBag.PositionTitle = new Pharos.Sys.BLL.SysDataDictionaryBLL().GetExtModelByDicSN(model.PositionId).Title;
            var roleBLL = new Pharos.Sys.BLL.SysRoleBLL();
            var roleIdArray = model.RoleIds.Split(',');
            var roleTitle = string.Empty;
            var roleStr = string.Empty;
            foreach (var item in roleIdArray)
            {
                roleTitle = roleBLL.GetModelByRoleId(int.Parse(item)).Title;
                if(string.IsNullOrEmpty(roleStr)) roleStr=roleTitle;
                else roleStr += "、" + roleTitle;
            }
            ViewBag.RoleStr = roleStr;
            ViewBag.StoreRoles = storeRoles;
            return View(model);
        }
        [HttpPost]
        public ActionResult UserInfo(int Id, string LoginPwd)
        {
            var userBLL = new Pharos.Sys.BLL.SysUserInfoBLL();
            var model = userBLL.GetModel(Id);
            model.LoginPwd = LoginPwd;
            var result = userBLL.SaveUser(model);
            return Content(result.ToJson());
        }
        #endregion

        #region 多商户登录
        //多商户登录
        public ActionResult Logins()
        {
            //cid是否只读
            int isReadOnly = 0;
            //登录logo
            string logo = "/Content/mythemes/default/images/login3/logo.png";
            //电话
            string phone = Pharos.Utility.Config.GetAppSettings("phone");
            

            //二级域名
            string d = "";

            if (!RouteData.Values["d0"].IsNullOrEmpty())
            {
                if (!RouteData.Values["dom"].IsNullOrEmpty())
                {
                    d = RouteData.Values["dom"].ToString();
                }
            }

            //API的CID
            int cID = Authorize.getCID(d);

            var user = new UserLogin();

            //请求API发生错误
            if (cID == -2)
            {
                return error("");
            }
            //输入的域名不存在商户
            else if (cID == 0)
            {
                return noBusiness();
            }
            //输入一级域名或者输入保留二级域名
            else if (cID == -1)
            {
                ////在crm里面并且是保留的二级域名
                //if (d.ToLower() == "erp")
                //{
                //    //获取cookie
                //    user = setUserLogin(cID, user);
                //}
                ////不在crm里面并且是保留的二级域名
                //else
                //{
                //    return noBusiness();
                //}

                //获取cookie
                user = setUserLogin(cID, user);
            }
            //输入的域名存在商户
            else if(cID>0)
            {
                var obj = UserInfoService.Find(o => o.CompanyId == cID);
                //CID在目前项目不存在
                if (obj == null)
                {
                    return noUser(cID.ToString());
                }
                else
                {
                    isReadOnly = 1;
                    user.CID = cID;
                    SysWebSettingBLL bll = new SysWebSettingBLL();
                    logo = bll.getLogo(cID);
                    //获取cookie
                    user = setUserLogin(cID, user);
                }
            }

            //cid是否只读
            ViewBag.isR = isReadOnly;
            //登录logo
            ViewBag.logo = logo;
            //电话
            ViewBag.phone = phone;

            return View("Logins",user);
        }
        //多商户登录
        [HttpPost]
        public ActionResult Logins(UserLogin user)
        {
            //cid是否只读
            ViewBag.isR = user.isReadOnly;
            //登录logo
            ViewBag.logo = user.logo;
            //电话
            string phone = Pharos.Utility.Config.GetAppSettings("phone");
            ViewBag.phone = phone;

            if (!ModelState.IsValid) return View(user);
            var op = Authorize.LoinValidator(CommonService.CompanyId);
            if (!op.Successed)
            {
                ViewBag.msg = op.Message;
                return View(user);
            }

            var pwd = Pharos.Utility.Security.MD5_Encrypt(user.UserPwd);
            var obj = UserInfoService.Find(o => o.LoginName == user.UserName && o.LoginPwd == pwd && o.Status == 1&&o.CompanyId==user.CID);
            if (obj == null)
            {
                ViewBag.msg = "商户号或帐户或密码输入不正确!";
                return View(user);
            }
            new Sys.CurrentUser().Login(obj, user.RememberMe);
            return Redirect(Url.Action("Index", "Home"));
        }
        //发生错误
        public ActionResult error(string msg)
        {
            if (msg.IsNullOrEmpty())
            {
                ViewBag.Message = "发生错误，请稍后再访问";
            }
            else
            {
                ViewBag.Message = Pharos.Utility.DESEncrypt.Decrypt(msg);
            }
            return View("error");
        }
        public ActionResult noBusiness()
        {
            ViewBag.Message = "无法访问，请检查网址是否正确或页面是否存在！";
            return View("noBusiness");
        }
        public ActionResult noUser(string cid)
        {
            ViewBag.cid = cid;
            return View("noUser");
        }


        /// <summary>
        /// 获取cookie
        /// </summary>
        /// <param name="cID">API的CID</param>
        /// <param name="u"></param>
        public UserLogin setUserLogin(int cID, UserLogin user)
        {
            if (Cookies.IsExist("remuc"))
            {
                //cookie的CID
                string cid = Cookies.Get("remuc", "_cid");
                if (cid.IsNullOrEmpty())
                {
                    cid = "0";
                }

                //输入的域名存在商户
                if (cID > 0)
                {
                    //API的CID等于cookie的CID
                    if (cid == cID.ToString())
                    {
                        user.CID = Convert.ToInt32(cid);
                        user.UserName = Cookies.Get("remuc", "_uname");
                        user.UserPwd = Cookies.Get("remuc", "_pwd");
                        user.RememberMe = true;
                    }
                }
                //输入任意网址
                else
                {
                    user.CID = Convert.ToInt32(cid);
                    user.UserName = Cookies.Get("remuc", "_uname");
                    user.UserPwd = Cookies.Get("remuc", "_pwd");
                    user.RememberMe = true;
                }

            }
            return user;
        }

        #endregion


    }

    public class UserLogin
    {
        /// <summary>
        /// 用户名
        /// </summary>
        [Display(Name = "用户名", Description = "4-20个字符。")]
        [Required(ErrorMessage = "×")]
        [StringLength(20, MinimumLength = 1, ErrorMessage = "×")]
        public string UserName { get; set; }

        /// <summary>
        /// 密码
        /// </summary>
        [Display(Name = "密码", Description = "6-20个字符。")]
        [Required(ErrorMessage = "×")]
        [StringLength(20, MinimumLength = 1, ErrorMessage = "×")]
        [DataType(DataType.Password)]
        public string UserPwd { get; set; }

        public bool RememberMe { get; set; }

        public string StoreId { get; set; }

        public int CID { get; set; }

        public string logo { get; set; }

        public int isReadOnly { get; set; }
    }
}