@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";
    ViewData.OpBtnInfo(new OpBtnInfo(addText: "新增商户", delText: "删除商户", hideDel: false,searchHeight:87));
}

<style type="text/css">
    .table-toolbar .s_tr td {
        padding-top:9px;
    }
</style>

@section search{
    <table class="table-toolbar">
        <tr>
            <td class="label-toolbar">
                <label>业务员：</label>
            </td>
            <td class="input-toolbar">
                @Html.DropDownList("AssignerUID", ViewBag.user as List<SelectListItem>, new { @class = "easyui-combobox datacontrol", data_options = "novalidate:true, editable: false,width:120" })
            </td>
            <td class="label-toolbar">
                <label>客户类型：</label>
            </td>
            <td class="input-toolbar">
                @Html.DropDownList("TraderTypeId", ViewBag.TraderType as List<SelectListItem>, new { @class = "easyui-combobox datacontrol", data_options = "novalidate:true,editable: false,width:120" })
            </td>
            <td class="label-toolbar">
                <label>跟踪状态：</label>
            </td>
            <td class="input-toolbar">
                @Html.DropDownList("TrackStautsId", ViewBag.TrackStautsId as List<SelectListItem>, new { @class = "easyui-combobox", data_options = "novalidate:true, editable: false,width:120" })
            </td>
            <td class="label-toolbar">
                <label>登记日期：</label>
            </td>
            <td class="input-toolbar">
                <input name="CreateDT_begin" id="" class="Wdate datacontrol" style="width: 100px;" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" />
            </td>
            <td class="label-toolbar">
                <label style="width:10px;margin-right:3px;position:relative;top:-4px;">-</label>
            </td>
            <td class="input-toolbar">
                <input name="CreateDT_end" id="" class="Wdate datacontrol" style="width: 100px;" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" />
            </td>

        </tr>

        <tr class="s_tr">
            <td class="label-toolbar">
                <label>区&nbsp;&nbsp;&nbsp;域：</label>
            </td>
            <td class="input-toolbar">
                <input id="Province" name="CurrentProvinceId" class="easyui-combobox" />
            </td>
            <td class="label-toolbar">
                <label style="width:10px;margin-right:3px;position:relative;top:-4px;">-</label>
            </td>
            <td class="input-toolbar">
                <input id="City" name="CurrentCityId" class="easyui-combobox" />
            </td>

            <td class="label-toolbar">
                <label>经营范围：</label>
            </td>
            <td class="input-toolbar">
                @Html.DropDownList("BusinessScopeId", ViewBag.BusinessScopeId as List<SelectListItem>, new { @class = "easyui-combobox", data_options = "novalidate:true, editable: false,width:120" })
            </td>

            <td class="label-toolbar">
                <label>关键字：</label>
            </td>
            <td class="input-toolbar" style="padding-right:10px;">
                @Html.DropDownList("keywordType", new List<SelectListItem>() { new SelectListItem() { Text = "按商户号", Value = "0" }, new SelectListItem() { Text = "按客户名称", Value = "1" }, new SelectListItem() { Text = "按联系人", Value = "2" }, new SelectListItem() { Text = "按手机号", Value = "3" } }, new { @class = "easyui-combobox datacontrol", data_options = "novalidate:true, editable: false,width:120" })
            </td>
            <td class="input-toolbar">
                <input name="keyword" class="datacontrol easyui-textbox font-12" placeholder="" data-options="prompt:'关键字',width:231" />
            </td>
        </tr>

    </table>
}
@section toolbar
{
    <a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-stale'" onclick="setStatus(1)">商户审核通过</a>
    <a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-stale'" onclick="setStatus(2)">设为无效商户</a>
    <a href="#" class="easyui-linkbutton cus1 linkbtn" data-options="iconCls:'icon-category'" id="TraderType">商户分类</a>
}
<script type="text/javascript">

    pharos.manager.$dg.datagrid({
        rowStyler: function (index, row) {
            if (row.Status == 2) return 'background-color:#ede9e9;color:#9d9c9c';
        }
    })


    pharos.manager.frozenColumns = [[
        { field: 'Id', checkbox: true },
        { field: 'FullName', title: '业务员', editor: { type: 'text', required: true }, width: 60 },
        { field: 'Title', title: '跟进状态', editor: { type: 'text', required: true }, width: 80 },
        { field: 'CID', title: '商户号', editor: { type: 'text', required: true }, width: 60 },
        { field: 'khTitle', title: '客户名称', editor: { type: 'text', required: true }, width: 100 }
    ]];

    pharos.manager.columns = [[
        { field: 'city', title: '城市', editor: { type: 'text', required: true }, width: 80 },
        { field: 'tType', title: '客户类型', editor: { type: 'text', required: true }, width: 100 },
        { field: 'bCategory', title: '经营类别', editor: { type: 'text', required: true }, width: 400 },
        { field: 'ExistStoreNum', title: '门店数量', editor: { type: 'text', required: true }, width: 70 },
        {
            field: 'oList', title: '采购需求', editor: { type: 'text', required: true }, width: 200, formatter: function (value, row, index) {
                if (value == ""||value==null) {
                    return "无";
                }
                else {
                    var v = value.replace(/,/g, '<br />');
                    return v;
                }
            }
        },
        { field: 'LinkMan', title: '联系人', editor: { type: 'text', required: true }, width: 90 },
        { field: 'MobilePhone', title: '手机', editor: { type: 'text', required: true }, width: 110 },
        {
            field: 'Status', title: '状态', editor: { type: 'text', required: true }, width: 60, formatter: function (value, row, index) {
                if (value == "0") {
                    return "未审核";
                } else if (value == "1") {
                    return "已审核";
                } else {
                    return "无效";
                }
            }
        },
        { field: 'CreateDT', title: '登记时间', editor: { type: 'text', required: true }, width: 100, formatter: function (value, row, index) { return new Date(value.replace(/-/g, '/')).format("yyyy-MM-dd"); } },
        { field: 'cFullName', title: '登记人', editor: { type: 'text', required: true }, width: 90 }
    ]];
    pharos.manager.addItem = function () {
        this.Id = "";
        openWin({ 'title': this.addText, 'width': 1000, 'height': 681, hideSave: false, 'url': this.editurl });
        //openDialog1000(this.addText, this.editurl);
    };
    pharos.manager.editItem = function (id, row) {
        this.Id = id;
        openDialog(this.editText, this.editurlNocache(), 1000, 681);
        //openDialog1000(this.addText, this.editurlNocache());
    }

    function removeBefore(row) {
        if (row.Status == 1) {
            $.messager.alert("提示", "已审核状态不能删除!");
            return false;
        }
        return true;
    }

    //商户审核通过、设为无效商户
    function setStatus(status) {
        var rows = pharos.manager.selectItems();
        if (!rows) return;
        var ids = $.map(rows, function (item) {
            return item.Id;
        }).join();
        $.post("@Url.Action("setStatus")", { Ids: ids, t: Math.random(), status: status }, function (d) {
            if (d.successed) {
                $.messager.alert("提示", "修改成功！", "info");
                pharos.manager.gridReload();
            } else {
                $.messager.alert("提示", "修改失败！" + d.message, "error");
            }
        }, "json");
    }

    $(function () {
        //商户分类
        $("#TraderType").click(function () {
            openWin({ 'title': '商户分类', 'width': 600, 'height': 350, hideSave: true, 'url': '/TraderType/Index' });
        });

        loadPCD(0, 0);

        //禁用业务员
        var v = "@ViewBag.all";
        if (v == "1")
        {
            $("#AssignerUID").combobox("disable");
        }
    });

    //加载省份
    function loadProvince() {
        $('#Province').combobox({
            url: '/Member/getProvince',
            valueField: 'AreaID',
            textField: 'Title',
            editable: false,
            width: 100,
            required: false,
            novalidate: true,
            validType: 'requiredForCombo',
            onChange: function (newValue, oldValue) {
                loadCity(newValue);
            }
        });

    }

    //加载城市
    function loadCity(provinceKey) {
        $('#City').combobox({
            url: '/Member/getCity?ProvinceID=' + provinceKey,
            valueField: 'AreaID',
            textField: 'Title',
            editable: false,
            width: 100,
            required: false,
            novalidate: true,
            validType: 'requiredForCombo'
        });

    }



    //加载省市区
    //pid:默认选中省ID
    //cid:默认选中城市ID
    function loadPCD(pid, cid) {
        loadProvince();
        loadCity(0);

        $('#Province').combobox('setValue', pid);
        $('#City').combobox('setValue', cid);
    }

</script>

