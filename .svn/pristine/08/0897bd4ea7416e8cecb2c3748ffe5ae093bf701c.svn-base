using Pharos.Logic.ApiData.Pos.Services;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Pharos.Logic.ApiData.Pos.Cache;
using Pharos.Logic.ApiData.Pos.Common;
using Pharos.Logic.ApiData.Pos.Sale;
using Pharos.Logic.ApiData.Pos.ValueObject;

namespace Pharos.Logic.ApiData.Pos.DataAdapter
{
    class MemoryCacheDataAdapter : IDataAdapter
    {
        public string StoreId { get; set; }

        public string MachineSN { get; set; }
        public string DeviceSn { get; set; }

        public int CompanyToken { get; set; }

        public bool IsSalesclerkTest { get; set; }
        public bool Enable
        {
            get { return true; }
        }
        /// <summary>
        /// 根据条码查找商品信息
        /// </summary>
        /// <param name="barcode"></param>
        /// <returns></returns>
        public ValueObject.ProductInfo GetProductInfoByBarcode(string barcode, bool isFindWeigh = false)
        {
            var result = default(ValueObject.ProductInfo);
            //先从内存中查找数据
            string key = KeyFactory.ProductKeyFactory(CompanyToken, StoreId, barcode);
            result = DataAdapterFactory.ProductCache.Get(key);
            if (result != null)
            {
                //缓存中存在该数据，直接返回
                return result;
            }
            else
            {
                //缓存中不存在符合条件的数据从数据库中查找
                var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
                result = dataAdapter.GetProductInfoByBarcode(barcode, isFindWeigh);
                //加到缓存中
                if (result != null)
                    DataAdapterFactory.ProductCache.Set(key, result);
                return result;
            }
        }

        public ValueObject.ProductInfo GetProductInfoFromBundlingByBarcode(string barcode)
        {
            var result = default(ValueObject.ProductInfo);
            //先从内存中查找数据
            string key = KeyFactory.ProductKeyFactory(CompanyToken, StoreId, barcode);
            result = DataAdapterFactory.ProductCache.Get(key);
            if (result != null)
            {
                //缓存中存在该数据，直接返回
                return result;
            }
            else
            {
                //缓存中不存在符合条件的数据从数据库中查找
                var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);

                result = dataAdapter.GetProductInfoFromBundlingByBarcode(barcode);
                //加到缓存中
                if (result != null)
                    DataAdapterFactory.ProductCache.Set(key, result);
                return result;
            }
        }

        public ValueObject.UserInfo GetUser(string account)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetUser(account);
        }

        public IEnumerable<ValueObject.UserInfo> GetStoreUsers(User.StoreOperateAuth storeOperateAuth)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetStoreUsers(storeOperateAuth);
        }

        public ValueObject.PageResult<ValueObject.InventoryResult> CheckedInventory(IEnumerable<int> categorySns, string keyword, int pageSize, int pageIndex)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.CheckedInventory(categorySns, keyword, pageSize, pageIndex);
        }

        public ValueObject.PageResult<ValueObject.InventoryResult> CheckedPrice(IEnumerable<int> categorySns, decimal from, decimal to, int pageSize, int pageIndex)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.CheckedPrice(categorySns, from, to, pageSize, pageIndex);
        }

        public ValueObject.MemberInfo GetMemberInfo(string phone, string cardNo, string uid)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetMemberInfo(phone, cardNo, uid);
        }

        public IEnumerable<ValueObject.CategoryDAO> GetStoreCategory()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetStoreCategory();
        }

        public void PosIncomePayout(string uid, decimal money, User.PosIncomePayoutMode mode)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.PosIncomePayout(uid, money, mode);
        }

        public ValueObject.BillHistoryInfo GetBillDetailsHistory(string paySn)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetBillDetailsHistory(paySn);
        }

        public IEnumerable<ValueObject.ReasonItem> GetReason(int mode)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetReason(mode);
        }

        //public void Refund(List<ValueObject.ChangeRefundItem> refundList, int reason, string paySn, decimal amount, string uid)
        //{
        //    var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken);
        //    dataAdapter.Refund(refundList, reason, paySn, amount, uid);
        //}

        public DateTime RefundAll(int reason, string paySn, decimal amount, string uid)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.RefundAll(reason, paySn, amount, uid);
        }

        public DateTime ChangeOrRefund(Sale.AfterSale.OrderChangeRefundSale changeList, int reason, MachineInformation machineInformation, string newPaySn, decimal amount, decimal receive, string uid, string apiCodes, DateTime saveTime)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.ChangeOrRefund(changeList, reason, machineInformation, newPaySn, amount, receive, uid, apiCodes,saveTime);
        }

        public void RecordPayment(string paySn, decimal amount, int apiCode, decimal change, decimal receive, string apiOrderSN = null, string cardNo = null)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.RecordPayment(paySn, amount, apiCode, change, receive, apiOrderSN, cardNo);
        }

        public ApiSetting GetApiSettings(int apiCode)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetApiSettings(apiCode);
        }

        public IEnumerable<ValueObject.BillListItem> GetBills(DateTime date, Range range, string paySn, string cashier)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetBills(date, range, paySn, cashier);
        }

        public void RegisterDevice(string deviceSn, ValueObject.DeviceType type)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.RegisterDevice(deviceSn, type);
        }

        public bool HasRegister(string deviceSn, ValueObject.DeviceType type, bool verfyState = true)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.HasRegister(deviceSn, type, verfyState);
        }

        public IEnumerable<ValueObject.Announcement> Announcements()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.Announcements();
        }

        public IEnumerable<KeyValuePair<Sale.Marketings.MarketingTimelinessLimit, Sale.Marketings.MarketingRule>> GetMarketingRules()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetMarketingRules();
        }

        public decimal GetMarketingRecordNumber(string marketingId, Sale.Marketings.MarketingQuotaMode mode)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetMarketingRecordNumber(marketingId, mode);
        }

        public void SaveMarketingRecord(string marketingId, decimal number)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.SaveMarketingRecord(marketingId, number);
        }

        public void SaveOrder(Sale.ShoppingCart shoppingCart, string apiCodes, DateTime saveTime)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.SaveOrder(shoppingCart, apiCodes,saveTime);
        }

        public ValueObject.DayReportResult DayMonthReport(DateTime from, DateTime to, Sale.Range range)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.DayMonthReport(from, to, range);
        }

        public IEnumerable<ValueObject.WarehouseInformations> GetWarehouseInformations()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetWarehouseInformations();
        }

        public IEnumerable<ValueObject.Activity> Activities()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.Activities();
        }


        public void AddWipeZero(int companyId, string paySn, decimal money)
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            dataAdapter.AddWipeZero(companyId, paySn, money);
        }

        public string GetStoreName()
        {
            var dataAdapter = DataAdapterFactory.DbFactory(MachinesSettings.Mode, StoreId, MachineSN, CompanyToken, DeviceSn);
            return dataAdapter.GetStoreName();
        }
    }
}
