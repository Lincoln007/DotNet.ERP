using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Newtonsoft.Json;
using System.IO;
using Pharos.Logic.ApiData.Pos.Sale.Barcodes;
using Newtonsoft.Json.Converters;
using System.Threading.Tasks;
using System.Threading;
using Pharos.Logic.ApiData.Pos.Exceptions;

namespace Pharos.Logic.ApiData.Pos.Sale.Suspend
{
    /// <summary>
    /// 挂单操作
    /// </summary>
    public class SaleSuspend
    {
        static SaleSuspend()
        {
            Expries = 1;
            Task.Factory.StartNew(() =>
            {
                while (true)
                {

                    Thread.Sleep(new TimeSpan(Expries, 0, 0, 0));
                }
            });
        }
        /// <summary>
        /// 挂单失效时间（默认为1天）
        /// </summary>
        public static int Expries { get; set; }
        public static void Suspend(ShoppingCart cart)
        {
            try
            {
                var statistics = cart.GetSaleStatistics();
                var details = new SuspendDetails()
                {
                    Amount = statistics.Receivable,
                    Count = statistics.Num,
                    SuspendDate = DateTime.Now,
                    OrderSN = cart.OrderSN
                };
                var suspendList = SuspendList.Factory(cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken, MachinesSettings.CachePath);
                suspendList.Add(details);
                suspendList.Save(MachinesSettings.CachePath, cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken);
                Save(cart, MachinesSettings.CachePath);
                cart.Clear();
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

        private static void Save(ShoppingCart cart, string path)
        {
            var fileName = string.Format("SaleDetails{0}.JSON", cart.OrderSN);
            var filePath = Path.Combine(path, fileName);

            using (StreamWriter sw = new StreamWriter(filePath, false, Encoding.UTF8))
            {
                JsonSerializer serializer = new JsonSerializer();
                JsonWriter writer = new JsonTextWriter(sw);
                serializer.Serialize(writer, cart.OrderList);
                writer.Close();
                sw.Close();
            }
        }


        public static IEnumerable<IBarcode> Read(ShoppingCart cart, string orderSN)
        {
            try
            {
                List<IBarcode> result = null;
                var fileName = string.Format("SaleDetails{0}.JSON", orderSN);
                var filePath = Path.Combine(MachinesSettings.CachePath, fileName);
                if (File.Exists(filePath))
                {
                    using (StreamReader sr = new StreamReader(filePath))
                    {
                        var json = sr.ReadToEnd();
                        result = JsonConvert.DeserializeObject<List<IBarcode>>(json, new BarcodeConverter(cart.MachineInformation.CompanyToken, cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn));
                    }
                }
                if (result != null && result.Count() > 0)
                {
                    cart.Clear();
                    cart.OrderList = result;
                    cart.ResetProduct(SaleStatus.Normal);
                }
                var suspendList = SuspendList.Factory(cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken, MachinesSettings.CachePath);
                suspendList.RemoveAll(o => o.OrderSN == orderSN);
                suspendList.Save(MachinesSettings.CachePath, cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken);
                File.Delete(filePath);
                return result;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }
        public static SuspendList Remove(ShoppingCart cart, string orderSN)
        {
            try
            {
                var suspendList = SuspendList.Factory(cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken, MachinesSettings.CachePath);
                var fileName = string.Format("SaleDetails{0}.JSON", orderSN);
                var filePath = Path.Combine(MachinesSettings.CachePath, fileName);
                suspendList.RemoveAll(o => o.OrderSN == orderSN);
                suspendList.Save(MachinesSettings.CachePath, cart.MachineInformation.StoreId, cart.MachineInformation.MachineSn, cart.MachineInformation.CompanyToken);
                File.Delete(filePath);
                return suspendList;
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

    }


}
