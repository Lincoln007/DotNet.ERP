using Pharos.Logic.OMS.IDAL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Data.Entity;
using Pharos.Utility.Helpers;
using Pharos.Utility;

namespace Pharos.Logic.OMS.BLL
{
    public class DepartMentService:BaseService<Entity.SysDepartments>
    {
        [Ninject.Inject]
        IBaseRepository<Entity.SysDepartments> DepartRepository { get; set; }
        [Ninject.Inject]
        IBaseRepository<Entity.SysUser> UserRepository { get; set; }
        public IEnumerable<dynamic> GetPageList(System.Collections.Specialized.NameValueCollection nvl)
        {
            var query = DepartRepository.GetQuery();
            var queryUser = UserRepository.GetQuery();
            var q = from x in query
                    orderby x.SortOrder
                    select new Entity.DepartMentExt()
                    {
                        Id=x.Id,
                        CreateDT=x.CreateDT,
                        CreateUID=x.CreateUID,
                        DeptCode=x.DeptCode,
                        Depth=x.Depth,
                        DeptId=x.DeptId,
                        PDeptId=x.PDeptId,
                        Title=x.Title,
                        SortOrder=x.SortOrder,
                        Status=x.Status,
                        UserCount = queryUser.Count(o => o.DeptId == x.DeptId),
                        ManagerTitle = (x.ManagerUId == null || x.ManagerUId == string.Empty) ? "" : queryUser.Where(o=>o.UserId==x.ManagerUId).Select(o=>o.FullName).FirstOrDefault(),
                        DeputyTitle = (x.DeputyUId == null || x.DeputyUId == string.Empty) ? "" : queryUser.Where(o => o.UserId == x.DeputyUId).Select(o => o.FullName).FirstOrDefault()
                    };
            var ms = q.ToList();
            var list = new List<Entity.DepartMentExt>();
            foreach (var dept in ms.Where(o => o.PDeptId <= 0))
            {
                SetChilds(dept, ms);
                dept.Index = list.Count;
                list.Add(dept);
            }
            return list;
        }
        public OpResult SaveOrUpdate(Entity.SysDepartments obj, short parentDepth)
        {
            if (DepartRepository.IsExists(o => o.DeptCode == obj.DeptCode && o.Id != obj.Id))
                return OpResult.Fail("该代码已存在!");
            if (obj.Id == 0)
            {
                obj.DeptId = DepartRepository.GetMaxInt(o =>(int?)o.DeptId);
                obj.CreateDT = DateTime.Now;
                obj.CreateUID = CurrentUser.UID;
                obj.SortOrder = DepartRepository.GetMaxInt(o => (int?)o.SortOrder);
                obj.Depth = ++parentDepth;
                DepartRepository.Add(obj, false);
            }
            else
            {
                var menu = DepartRepository.Get(obj.Id);
                obj.ToCopyProperty(menu, new List<string>() { "CreateDT", "CreateUID", "DeptId", "SortOrder", "Depth" });
            }
            DepartRepository.SaveChanges();
            return OpResult.Success();
        }
        public OpResult Deletes(int[] ids)
        {
            var list= DepartRepository.GetQuery(o => ids.Contains(o.Id)).ToList();
            DepartRepository.RemoveRange(list);
            return OpResult.Success();
        }
        public Entity.SysDepartments Get(int deptid)
        {
            return DepartRepository.Find(o => o.DeptId == deptid);
        }
        public Dictionary<int, string> GetFullTitle(int deptid)
        {
            var queryDept = DepartRepository.GetQuery();
            var query = from x in queryDept
                        where x.DeptId == deptid
                        select new
                        {
                            x.DeptId,
                            x.Title,
                            PDepartMent = x.DeptId > 0 ? queryDept.Where(i => i.DeptId == queryDept.Where(o => o.DeptId == x.DeptId).Select(o => o.PDeptId).FirstOrDefault()).Select(o => o.Title).FirstOrDefault() + "/" : string.Empty,
                        };
            return query.ToDictionary(o => o.DeptId, o => o.PDepartMent + o.Title);
        }
        public void MoveItem(short mode, int deptId)
        {
            var obj = DepartRepository.Find(o => o.DeptId == deptId);
            var list = DepartRepository.GetQuery(o => o.PDeptId == obj.PDeptId).OrderBy(o => o.SortOrder).ToList();
            switch (mode)
            {
                case 2://下移
                    var obj1 = list.LastOrDefault();
                    if (obj.Id != obj1.Id)
                    {
                        Entity.SysDepartments next = null;
                        for (var i = 0; i < list.Count; i++)
                        {
                            if (obj.Id == list[i].Id)
                            {
                                next = list[i + 1]; break;
                            }
                        }
                        if (next != null)
                        {
                            var sort = obj.SortOrder;
                            obj.SortOrder = next.SortOrder;
                            next.SortOrder = sort;
                            DepartRepository.SaveChanges();
                        }
                    }
                    break;
                default://上移
                     var obj2 = list.FirstOrDefault();
                    if (obj.Id != obj2.Id)
                    {
                        Entity.SysDepartments prev = null;
                        for (var i=0;i<list.Count;i++)
                        {
                            if (obj.Id == list[i].Id)
                            {
                                prev = list[i - 1]; break;
                            }
                        }
                        if (prev != null)
                        {
                            var sort = obj.SortOrder;
                            obj.SortOrder = prev.SortOrder;
                            prev.SortOrder = sort;
                            DepartRepository.SaveChanges();
                        }
                    }
                    break;
            }
        }
        public void MoveUpItem(short mode, int deptId)
        {
            var obj = DepartRepository.Find(o => o.DeptId == deptId);
            var list = DepartRepository.GetQuery(o => o.PDeptId <= 0).OrderBy(o => o.SortOrder).ToList();
            switch (mode)
            {
                case 4://降级
                    var obj1 = list.LastOrDefault(o =>o.DeptId!=obj.DeptId && o.SortOrder <= obj.SortOrder);//上同节点
                    if (obj1!=null && obj.Id != obj1.Id)
                    {
                        var last = DepartRepository.GetQuery(o => o.PDeptId == obj1.DeptId).OrderByDescending(o => o.SortOrder).FirstOrDefault();
                        obj.PDeptId = obj1.DeptId;
                        obj.Depth =Convert.ToInt16( obj1.Depth +1);
                        if (last != null)
                        {
                            obj.SortOrder =last.SortOrder+1;
                        }
                        DepartRepository.SaveChanges();
                    }
                    break;
                default://升级
                    var obj2 = list.FirstOrDefault(o => o.DeptId == obj.PDeptId);
                    if (obj2 != null && obj.Id != obj2.Id)
                    {
                        var next = list.FirstOrDefault(o => o.DeptId != obj2.DeptId && o.SortOrder >= obj2.SortOrder);//下同节点
                        obj.PDeptId = 0;
                        obj.SortOrder = obj2.SortOrder+1;
                        obj.Depth = obj2.Depth;
                        if (next != null && obj.SortOrder>=next.SortOrder)
                        {
                            next.SortOrder++;//下节点下移
                        }
                        DepartRepository.SaveChanges();
                    }
                    break;
            }
        }
        public void SetState(short mode, int deptId)
        {
            var obj = Get(deptId);
            obj.Status = mode == 1;
            DepartRepository.SaveChanges();
        }
        public IEnumerable<dynamic> GetInput(string searchName)
        {
            var query= DepartRepository.GetQuery(o => o.Title.Contains(searchName) || (o.DeptCode!=null && o.DeptCode.Contains(searchName)));
            var queryDept=DepartRepository.GetQuery();
            query = query.Where(o => o.Status);
            var q = from x in query
                    select new
                    { 
                        x.DeptId,
                        x.Title,
                        x.PDeptId,
                        PDeptTitle = queryDept.Where(i => i.DeptId == queryDept.Where(o => o.DeptId == x.DeptId).Select(o => o.PDeptId).FirstOrDefault()).Select(o => o.Title).FirstOrDefault() + "/"
                    };
            return q.ToList();
        }
        void SetChilds(Entity.DepartMentExt dept,List<Entity.DepartMentExt> alls)
        {
            dept.Childrens = alls.Where(o => o.PDeptId == dept.DeptId).ToList();
            var prev = alls.LastOrDefault(o => o.DeptId != dept.DeptId && o.SortOrder <= dept.SortOrder);//上同节点
            if (prev != null) dept.PrevId = prev.DeptId;
            int i = 0;
            foreach (var child in dept.Childrens)
            {
                child.Index = i++;
                child.ParentId = dept.Id;
                SetChilds(child, alls);
            }
        }
    }
}
