@model Pharos.Sys.Entity.SysCustomMenus
@{
    ViewBag.Title = Pharos.Sys.SysConstPool.Page_Title;
    Layout = "~/Views/Shared/_FormLayout.cshtml";
}

@*<h2>RoleSettingMenus</h2>*@
<div class="default-form">
    @using (Html.BeginForm("SaveRoleSettingMenus", "SysAdmin", FormMethod.Post))
    {
        @Html.HiddenFor(o => o.Id)
        @Html.HiddenFor(o => o.ObjId)
        @Html.HiddenFor(o => o.MenuIds)
        <div class="content">
            <div id="layout" data-options="fit:true,border:false">
                <div data-options="region:'west',split:true">
                    <ul id="sys" class="easyui-tree" data-options="url:'@Url.Action("GetMenusTreeLists", "SysAdmin")',checkbox:true,onLoadSuccess:treeLoadSuccess"></ul>
                </div>
            </div>
        </div>
    }
</div>
<script>
    var menuIds = "";
    var $tree = $("#sys");
    function treeLoadSuccess() {
        var mIds = $("#MenuIds").val();
        //var mIdArr = mIds.split(',');

        //$.each(mIdArr, function (index, value) {
        //    var n = $("#sys").tree('find', value);
        //    if (n) {
        //        $("#sys").tree('check', n.target);
        //    }
        //})


        var nodes = $tree.tree("getChildren");
        var allnodes = mIds.split(',');
        //var getDatas = $tree.tree("getData");
        $.each(nodes, function (i, item) {
            if (isExit(allnodes,item.id)) {
                var node = $tree.tree('find', item.id);
                if (node.children == null) {
                    if (node) {
                        $tree.tree('check', node.target);
                    }
                }
            }
        })

    }
    //判断数组是否包含子项
    function isExit(list, val) {
        var result = false;
        $.each(list, function (index, temp) {
            if (temp == val) {
                result = true;
            }
        });
        return result;
    }

    function getChecked() {
        //var nodes = $('#sys').tree('getChecked');
        var nodes = $('#sys').tree('getChecked', ['checked', 'indeterminate']);
        var s = '';
        for (var i = 0; i < nodes.length; i++) {
            if (s != '')
                s += ',';
            s += nodes[i].id;
        }
        menuIds = s;
    }

    function submitform() {
        $('.default-form form').submit();
    }
    function Refresh(result) {
        $.messager.alert("提示", "操作成功!");
        pharos.easyui.dialog.topClose("formDiv");
        pharos.easyui.dialog.curJquery("formDiv")("#grid").datagrid("reload");
    }
    function SaveBefore() {
        getChecked();
        $("#MenuIds").val(menuIds);
    }
</script>
